<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - The Blinds Warehouse</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .upload-area {
            background: white;
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 300px;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 16px;
            cursor: pointer;
            min-width: 150px;
        }

        .team-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #10b981);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .metric-change.positive { color: #10b981; }
        .metric-change.negative { color: #ef4444; }

        .sales-reps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .rep-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.3s ease;
        }

        .rep-card:hover {
            transform: translateY(-5px);
        }

        .rep-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .rep-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e40af;
        }

        .rep-area {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .performance-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-good {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .progress-section {
            margin-bottom: 25px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
        }

        .progress-target {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: #f3f4f6;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .progress-excellent {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-good {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-poor {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .rep-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .rep-metric {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .rep-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e40af;
        }

        .rep-metric-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .variance {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
        }

        .variance.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .variance.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .data-table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            background: #1e40af;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .status-message {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .sales-reps {
                grid-template-columns: 1fr;
            }
            
            .rep-metrics {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Sales Performance Dashboard</h1>
            <p>The Blinds Warehouse - Real-time Team Performance Tracking</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">
                Auto-loads from data/baseline-data.csv or upload CSV files directly
            </p>
        </div>

        <div class="status-message" id="statusMessage">
            📊 Loading dashboard with actual sales data (Mar-Jun 2025)...
        </div>

        <div class="controls">
            <div class="upload-area" id="uploadArea">
                <div style="font-size: 2rem; margin-bottom: 10px;">📁</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">Upload Sales Data</div>
                <div style="color: #6b7280;">Drag & drop CSV file or click to browse</div>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
            </div>

            <div class="filter-controls">
                <select id="monthFilter" class="filter-select">
                    <option value="">All Months</option>
                </select>
                <select id="repFilter" class="filter-select">
                    <option value="">All Sales Reps</option>
                </select>
                <button class="btn btn-primary" onclick="loadSampleData()">Load Actual Data</button>
            </div>
        </div>

        <div class="team-overview" id="teamOverview">
            <!-- Team metrics will be populated here -->
        </div>

        <div class="sales-reps" id="salesReps">
            <!-- Sales rep cards will be populated here -->
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">
                    Last 12 Months Sales
                    <span id="chartFilter" style="font-size: 0.8rem; color: #6b7280; font-weight: normal;"></span>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Sales by Rep</div>
                <div class="chart-container">
                    <canvas id="repChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">Detailed Performance Data</div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Sales Rep</th>
                            <th>Month</th>
                            <th>Sales</th>
                            <th>Orders</th>
                            <th>Avg Invoice</th>
                            <th>Target</th>
                            <th>Progress</th>
                            <th>Variance</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Data rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /*
        REPOSITORY SETUP INSTRUCTIONS:
        
        1. Create a GitHub repository for this dashboard
        2. Add this HTML file as index.html
        3. Create a data/ folder in your repository
        4. Upload your CSV file as data/baseline-data.csv
        5. Enable GitHub Pages in repository settings
        6. Dashboard will auto-load data from data/baseline-data.csv
        
        CSV Format Expected:
        - QuickBooks export format with headers: Sales Rep,Transaction date,Transaction type,No.,Customer,Line description,Product/Service,Distribution account,Amount
        - Will automatically aggregate transactions by sales rep and month
        */
        
        let salesData = [];
        let filteredData = [];
        let trendChart = null;
        let repChart = null;

        // Official sales targets by rep and month
        const targets = {
            'Michael Bell': { 'Mar': 16000, 'Apr': 16000, 'May': 16000, 'Jun': 16000, 'default': 16000 },
            'Ria Wise': { 'Mar': 12000, 'Apr': 16000, 'May': 20000, 'Jun': 20000, 'default': 16000 },
            'Adam Bell': { 'default': 0 } // No official target set
        };

        // Actual sales data from March 1 - June 27, 2025
        const actualSalesData = [
            { rep: 'Ria Wise', month: 'Mar 2025', sales: 13009.17, orders: 14, customer: 'Various', date: '01/03/2025' },
            { rep: 'Michael Bell', month: 'Mar 2025', sales: 2427.50, orders: 4, customer: 'Various', date: '01/03/2025' },
            { rep: 'Michael Bell', month: 'Apr 2025', sales: 9241.08, orders: 13, customer: 'Various', date: '01/04/2025' },
            { rep: 'Ria Wise', month: 'Apr 2025', sales: 17413.32, orders: 20, customer: 'Various', date: '01/04/2025' },
            { rep: 'Michael Bell', month: 'May 2025', sales: 9462.50, orders: 12, customer: 'Various', date: '01/05/2025' },
            { rep: 'Ria Wise', month: 'May 2025', sales: 15460.86, orders: 15, customer: 'Various', date: '01/05/2025' },
            { rep: 'Adam Bell', month: 'May 2025', sales: 60.00, orders: 1, customer: 'Various', date: '01/05/2025' },
            { rep: 'Ria Wise', month: 'Jun 2025', sales: 16774.15, orders: 16, customer: 'Various', date: '01/06/2025' },
            { rep: 'Michael Bell', month: 'Jun 2025', sales: 13159.99, orders: 13, customer: 'Various', date: '01/06/2025' }
        ];

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseCSV(e.target.result);
                    updateStatus('✅ Data loaded successfully!');
                } catch (error) {
                    updateStatus('❌ Error parsing CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            salesData = [];
            
            // Find the header row with "Sales Rep,Transaction date,..."
            let headerRowIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase();
                if (line.includes('sales rep') && line.includes('transaction date') && line.includes('amount')) {
                    headerRowIndex = i;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                throw new Error('Could not find data header row in CSV');
            }
            
            console.log('Found header at line', headerRowIndex);
            
            // Process transaction rows (after header)
            const transactions = [];
            for (let i = headerRowIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Parse CSV line handling quoted fields
                const columns = [];
                let currentField = '';
                let inQuotes = false;
                let chars = line.split('');
                
                for (let j = 0; j < chars.length; j++) {
                    const char = chars[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        columns.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                columns.push(currentField.trim()); // Add last field
                
                // Validate we have enough columns and extract data
                if (columns.length >= 9) {
                    const salesRep = columns[0].replace(/"/g, '').trim();
                    const transactionDate = columns[1].replace(/"/g, '').trim();
                    const transactionType = columns[2].replace(/"/g, '').trim();
                    const customer = columns[4] ? columns[4].replace(/"/g, '').trim() : 'Unknown';
                    const amountStr = columns[8] ? columns[8].replace(/[£,"]/g, '').trim() : '0';
                    const amount = parseFloat(amountStr);
                    
                    // Only include valid invoice transactions with actual sales rep names
                    if (salesRep && 
                        salesRep !== 'Sales Rep' && 
                        salesRep.length < 50 && // Exclude company names (too long)
                        !salesRep.toLowerCase().includes('warehouse') &&
                        !salesRep.toLowerCase().includes('blinds') &&
                        transactionType === 'Invoice' && 
                        transactionDate &&
                        amount > 0) {
                        
                        transactions.push({
                            rep: salesRep,
                            date: transactionDate,
                            customer: customer,
                            amount: amount
                        });
                    }
                }
            }
            
            console.log('Processed', transactions.length, 'valid transactions');
            console.log('Sample transactions:', transactions.slice(0, 5));
            
            // Aggregate by rep and month
            const aggregated = {};
            transactions.forEach(transaction => {
                const date = parseDate(transaction.date);
                if (date) {
                    const monthKey = formatMonth(date);
                    const key = `${transaction.rep}-${monthKey}`;
                    
                    if (!aggregated[key]) {
                        aggregated[key] = {
                            rep: transaction.rep,
                            month: monthKey,
                            sales: 0,
                            orders: 0,
                            customer: 'Various',
                            date: transaction.date
                        };
                    }
                    
                    aggregated[key].sales += transaction.amount;
                    aggregated[key].orders += 1;
                }
            });
            
            salesData = Object.values(aggregated);
            console.log('Final aggregated data:', salesData);
            
            if (salesData.length === 0) {
                throw new Error('No valid sales data found in CSV');
            }
            
            updateDashboard();
        }

        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            
            // Assume DD/MM/YYYY format
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // JS months are 0-based
            const year = parseInt(parts[2]);
            
            return new Date(year, month, day);
        }

        function formatMonth(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function aggregateData(data) {
            const aggregated = {};
            
            data.forEach(item => {
                const key = `${item.rep}-${item.month}`;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        rep: item.rep,
                        month: item.month,
                        sales: 0,
                        orders: 0,
                        customer: 'Various',
                        date: item.date
                    };
                }
                aggregated[key].sales += item.sales;
                aggregated[key].orders += item.orders;
            });
            
            return Object.values(aggregated);
        }

        function getTarget(rep, month) {
            if (targets[rep] && typeof targets[rep] === 'object') {
                const monthShort = month.split(' ')[0];
                return targets[rep][monthShort] || targets[rep].default;
            }
            return targets[rep] || 10000;
        }

        function getPerformanceBadge(percentage) {
            if (percentage >= 100) return { class: 'badge-excellent', text: 'Excellent' };
            if (percentage >= 80) return { class: 'badge-good', text: 'Good' };
            return { class: 'badge-poor', text: 'Needs Improvement' };
        }

        function getProgressClass(percentage) {
            if (percentage >= 100) return 'progress-excellent';
            if (percentage >= 80) return 'progress-good';
            return 'progress-poor';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').innerHTML = message;
        }

        function loadSampleData() {
            salesData = [...actualSalesData];
            updateDashboard();
            updateStatus('📊 Actual sales data loaded (Mar-Jun 2025) - Ready for team review!');
        }

        // Function to load data from repository file
        async function loadFromRepository() {
            try {
                const response = await fetch('./data/baseline-data.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    parseCSV(csvText);
                    updateStatus('✅ Data loaded from repository file!');
                } else {
                    // Fallback to actual data if repository file not found
                    loadSampleData();
                    updateStatus('📊 Repository file not found - using embedded data');
                }
            } catch (error) {
                // Fallback to actual data if repository loading fails
                loadSampleData();
                updateStatus('📊 Using embedded sales data (Mar-Jun 2025)');
            }
        }

        function updateDashboard() {
            filteredData = filterData();
            updateFilters();
            updateTeamOverview();
            updateSalesReps();
            updateCharts();
            updateDataTable();
        }

        function filterData() {
            const monthFilter = document.getElementById('monthFilter').value;
            const repFilter = document.getElementById('repFilter').value;
            
            return salesData.filter(item => {
                const monthMatch = !monthFilter || item.month === monthFilter;
                const repMatch = !repFilter || item.rep === repFilter;
                return monthMatch && repMatch;
            });
        }

        function updateFilters() {
            const monthFilter = document.getElementById('monthFilter');
            const repFilter = document.getElementById('repFilter');
            
            // Update month filter
            const months = [...new Set(salesData.map(item => item.month))].sort();
            const currentMonth = monthFilter.value;
            monthFilter.innerHTML = '<option value="">All Months</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                if (month === currentMonth) option.selected = true;
                monthFilter.appendChild(option);
            });
            
            // Update rep filter
            const reps = [...new Set(salesData.map(item => item.rep))].sort();
            const currentRep = repFilter.value;
            repFilter.innerHTML = '<option value="">All Sales Reps</option>';
            reps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep;
                option.textContent = rep;
                if (rep === currentRep) option.selected = true;
                repFilter.appendChild(option);
            });
        }

        function updateTeamOverview() {
            const overview = document.getElementById('teamOverview');
            const totalSales = filteredData.reduce((sum, item) => sum + item.sales, 0);
            const totalOrders = filteredData.reduce((sum, item) => sum + item.orders, 0);
            const avgInvoice = totalOrders > 0 ? totalSales / totalOrders : 0;
            const activeReps = new Set(filteredData.map(item => item.rep)).size;
            
            overview.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${formatCurrency(totalSales)}</div>
                    <div class="metric-label">Total Sales</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${totalOrders}</div>
                    <div class="metric-label">Total Orders</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${formatCurrency(avgInvoice)}</div>
                    <div class="metric-label">Average Invoice</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${activeReps}</div>
                    <div class="metric-label">Active Sales Reps</div>
                </div>
            `;
        }

        function updateSalesReps() {
            const repsContainer = document.getElementById('salesReps');
            const repData = {};
            
            // Aggregate data by rep
            filteredData.forEach(item => {
                if (!repData[item.rep]) {
                    repData[item.rep] = { sales: 0, orders: 0, target: 0 };
                }
                repData[item.rep].sales += item.sales;
                repData[item.rep].orders += item.orders;
                repData[item.rep].target += getTarget(item.rep, item.month);
            });
            
            const repCards = Object.entries(repData).map(([rep, data], index) => {
                const avgInvoice = data.orders > 0 ? data.sales / data.orders : 0;
                const progress = data.target > 0 ? (data.sales / data.target) * 100 : 0;
                const variance = data.sales - data.target;
                const badge = getPerformanceBadge(progress);
                const progressClass = getProgressClass(progress);
                const area = `Area ${index + 1}`;
                
                return `
                    <div class="rep-card">
                        <div class="rep-header">
                            <div>
                                <div class="rep-name">${rep}</div>
                                <div class="rep-area">${area}</div>
                            </div>
                            <div class="performance-badge ${badge.class}">${badge.text}</div>
                        </div>
                        
                        <div class="progress-section">
                            <div class="progress-header">
                                <div class="progress-percentage">${Math.round(progress)}%</div>
                                <div class="progress-target">${formatCurrency(data.sales)} of ${formatCurrency(data.target)} target</div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar ${progressClass}" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                        
                        <div class="rep-metrics">
                            <div class="rep-metric">
                                <div class="rep-metric-value">${data.orders}</div>
                                <div class="rep-metric-label">Orders</div>
                            </div>
                            <div class="rep-metric">
                                <div class="rep-metric-value">${formatCurrency(avgInvoice)}</div>
                                <div class="rep-metric-label">Avg Invoice</div>
                            </div>
                        </div>
                        
                        <div class="variance ${variance >= 0 ? 'positive' : 'negative'}">
                            ${variance >= 0 ? '+' : ''}${formatCurrency(variance)} vs Target
                        </div>
                    </div>
                `;
            }).join('');
            
            repsContainer.innerHTML = repCards;
        }

        function updateCharts() {
            // Check if Chart.js is available (with max 5 retries)
            if (typeof Chart === 'undefined') {
                if (!window.chartRetryCount) window.chartRetryCount = 0;
                window.chartRetryCount++;
                
                if (window.chartRetryCount <= 5) {
                    console.log(`Chart.js not loaded yet, attempt ${window.chartRetryCount}/5`);
                    setTimeout(updateCharts, 500);
                    return;
                } else {
                    console.log('Chart.js failed to load after 5 attempts, showing fallback');
                    showChartFallback();
                    return;
                }
            }
            
            // Reset retry counter on success
            window.chartRetryCount = 0;
            console.log('Chart.js is available, creating charts...');
            
            // Update chart title filter indicator
            const repFilter = document.getElementById('repFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const chartFilterElement = document.getElementById('chartFilter');
            
            let filterText = '';
            if (repFilter && monthFilter) {
                filterText = ` - ${repFilter} (${monthFilter})`;
            } else if (repFilter) {
                filterText = ` - ${repFilter}`;
            } else if (monthFilter) {
                filterText = ` - ${monthFilter}`;
            }
            
            if (chartFilterElement) {
                chartFilterElement.textContent = filterText;
            }
            
            updateTrendChart();
            updateRepChart();
        }

        function showChartFallback() {
            // Show text-based charts if Chart.js fails to load
            const trendContainer = document.getElementById('trendChart').parentElement;
            const repContainer = document.getElementById('repChart').parentElement;
            
            // Create fallback trend chart (last 12 months, respecting filters)
            const monthlyData = {};
            filteredData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = 0;
                }
                monthlyData[item.month] += item.sales;
            });
            
            // Sort and get last 12 months
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const dateA = new Date(yearA, getMonthIndex(monthA));
                const dateB = new Date(yearB, getMonthIndex(monthB));
                return dateA - dateB;
            });
            
            const last12Months = sortedMonths.slice(-12);
            
            const trendFallback = `
                <div style="padding: 20px; text-align: center;">
                    <h4 style="margin-bottom: 20px; color: #374151;">Last 12 Months Sales</h4>
                    ${last12Months.map(month => `
                        <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">
                            <strong>${month}</strong>: ${formatCurrency(monthlyData[month])}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Create fallback rep chart
            const repTotals = {};
            filteredData.forEach(item => {
                if (!repTotals[item.rep]) {
                    repTotals[item.rep] = 0;
                }
                repTotals[item.rep] += item.sales;
            });
            
            const total = Object.values(repTotals).reduce((a, b) => a + b, 0);
            const repFallback = `
                <div style="padding: 20px; text-align: center;">
                    <h4 style="margin-bottom: 20px; color: #374151;">Sales by Rep</h4>
                    ${Object.entries(repTotals).map(([rep, sales]) => {
                        const percentage = total > 0 ? ((sales / total) * 100).toFixed(1) : 0;
                        return `
                            <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">
                                <strong>${rep}</strong>: ${formatCurrency(sales)} (${percentage}%)
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            trendContainer.innerHTML = trendFallback;
            repContainer.innerHTML = repFallback;
        }

        function updateTrendChart() {
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.log('Trend chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
                trendChart = null;
            }
            
            // Group data by month (respecting sales rep filter)
            const monthlyData = {};
            filteredData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = 0;
                }
                monthlyData[item.month] += item.sales;
            });
            
            if (Object.keys(monthlyData).length === 0) {
                canvas.parentElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #6b7280;">No data to display</div>';
                return;
            }
            
            // Sort months chronologically and get last 12 months
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const dateA = new Date(yearA, getMonthIndex(monthA));
                const dateB = new Date(yearB, getMonthIndex(monthB));
                return dateA - dateB;
            });
            
            // Take last 12 months (or all available if less than 12)
            const last12Months = sortedMonths.slice(-12);
            const chartData = last12Months.map(month => monthlyData[month]);
            
            try {
                trendChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last12Months,
                        datasets: [{
                            label: 'Monthly Sales',
                            data: chartData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Sales: ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                console.log('Trend chart created successfully');
            } catch (error) {
                console.error('Error creating trend chart:', error);
                showChartFallback();
            }
        }

        function updateRepChart() {
            const canvas = document.getElementById('repChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (repChart) {
                repChart.destroy();
                repChart = null;
            }
            
            const repTotals = {};
            filteredData.forEach(item => {
                if (!repTotals[item.rep]) {
                    repTotals[item.rep] = 0;
                }
                repTotals[item.rep] += item.sales;
            });
            
            const labels = Object.keys(repTotals);
            const data = Object.values(repTotals);
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            if (labels.length === 0) {
                canvas.parentElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #6b7280;">No data to display</div>';
                return;
            }
            
            try {
                repChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });
            } catch (error) {
                console.error('Error creating rep chart:', error);
                canvas.parentElement.innerHTML = '<div style="text-align: center; padding: 50px; color: #6b7280;">Chart temporarily unavailable</div>';
            }
        }

        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            if (!tbody) return;
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #6b7280;">No data available</td></tr>';
                return;
            }
            
            const rows = filteredData.map(item => {
                const target = getTarget(item.rep, item.month);
                const progress = target > 0 ? (item.sales / target) * 100 : 0;
                const variance = item.sales - target;
                const avgInvoice = item.orders > 0 ? item.sales / item.orders : 0;
                
                // Color coding for progress
                let progressColor = '#ef4444'; // Red for poor
                if (progress >= 100) progressColor = '#10b981'; // Green for excellent
                else if (progress >= 80) progressColor = '#f59e0b'; // Orange for good
                
                return `
                    <tr>
                        <td style="font-weight: 600;">${item.rep}</td>
                        <td>${item.month}</td>
                        <td style="font-weight: 600; color: #1e40af;">${formatCurrency(item.sales)}</td>
                        <td>${item.orders}</td>
                        <td>${formatCurrency(avgInvoice)}</td>
                        <td>${target > 0 ? formatCurrency(target) : 'No target'}</td>
                        <td style="color: ${progressColor}; font-weight: 600;">${target > 0 ? Math.round(progress) + '%' : '-'}</td>
                        <td style="color: ${variance >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                            ${target > 0 ? (variance >= 0 ? '+' : '') + formatCurrency(variance) : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add summary row
            const totalSales = filteredData.reduce((sum, item) => sum + item.sales, 0);
            const totalOrders = filteredData.reduce((sum, item) => sum + item.orders, 0);
            const totalTargets = filteredData.reduce((sum, item) => sum + getTarget(item.rep, item.month), 0);
            const totalVariance = totalSales - totalTargets;
            const overallProgress = totalTargets > 0 ? (totalSales / totalTargets) * 100 : 0;
            const overallAvg = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            const summaryRow = `
                <tr style="background: #f8fafc; border-top: 2px solid #3b82f6; font-weight: 700;">
                    <td>TOTAL</td>
                    <td>-</td>
                    <td style="color: #1e40af;">${formatCurrency(totalSales)}</td>
                    <td>${totalOrders}</td>
                    <td>${formatCurrency(overallAvg)}</td>
                    <td>${formatCurrency(totalTargets)}</td>
                    <td style="color: ${overallProgress >= 100 ? '#10b981' : overallProgress >= 80 ? '#f59e0b' : '#ef4444'};">
                        ${Math.round(overallProgress)}%
                    </td>
                    <td style="color: ${totalVariance >= 0 ? '#10b981' : '#ef4444'};">
                        ${totalVariance >= 0 ? '+' : ''}${formatCurrency(totalVariance)}
                    </td>
                </tr>
            `;
            
            tbody.innerHTML = rows + summaryRow;
        }

        function getMonthIndex(monthName) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months.indexOf(monthName);
        }

        // Event listeners
        document.getElementById('monthFilter').addEventListener('change', updateDashboard);
        document.getElementById('repFilter').addEventListener('change', updateDashboard);

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load from repository first, fallback to embedded data
            loadFromRepository();
        });
    </script>
</body>
</html>
