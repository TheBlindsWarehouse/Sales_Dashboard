<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blinds Warehouse Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .dashboard-content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .sales-rep-section {
            margin-bottom: 30px;
        }
        
        .sales-rep-header {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .sales-rep-header h3 {
            color: #495057;
            font-size: 1.4em;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            display: none;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }
        
        .filters-container {
            display: flex;
            gap: 20px;
            align-items: end;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            color: #333;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .clear-filters-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            height: fit-content;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
        }
        
        .filtered-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        /* Clickable sales cells */
        .clickable-sales {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
            transition: all 0.2s ease;
        }
        
        .clickable-sales:hover {
            background-color: #f0f4ff !important;
            color: #5a67d8;
            font-weight: 600;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .order-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .order-summary-item {
            text-align: center;
        }
        
        .order-summary-item .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .order-summary-item .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .orders-table {
            margin-top: 20px;
        }
        
        .orders-table table {
            font-size: 0.9em;
        }
        
        .orders-table th {
            background: #f8f9fa;
            color: #333;
            font-size: 0.85em;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .dashboard-content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>The Blinds Warehouse</h1>
            <p>Sales Dashboard - Monthly Performance Analysis</p>
        </div>
        
        <div class="dashboard-content">
            <div class="loading" id="loading">
                <h3>Loading dashboard data...</h3>
            </div>
            
            <div class="error" id="error"></div>
            
            <div id="dashboardResults" style="display: none;">
                <!-- Filters Section -->
                <div class="section">
                    <h2>Filters</h2>
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="salesRepFilter">Sales Rep:</label>
                            <select id="salesRepFilter" onchange="applyFilters()">
                                <option value="">All Sales Reps</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="fyFilter">Financial Year:</label>
                            <select id="fyFilter" onchange="onFYFilterChange()">
                                <option value="">All Financial Years</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="monthFilter">Month:</label>
                            <select id="monthFilter" onchange="applyFilters()">
                                <option value="">All Months</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="section">
                    <h2>Summary</h2>
                    <div class="summary-cards" id="summaryCards"></div>
                </div>
                
                <!-- Sales Performance Table -->
                <div class="section">
                    <h2>Monthly Sales Performance by Rep</h2>
                    <p style="color: #666; margin-bottom: 15px; font-style: italic;">
                        ðŸ’¡ Click on any sales total to view individual orders
                    </p>
                    <div class="table-container">
                        <table id="performanceTable">
                            <thead>
                                <tr>
                                    <th>Sales Rep</th>
                                    <th>Month</th>
                                    <th class="number">Total Sales (Â£)</th>
                                    <th class="number">Number of Orders</th>
                                    <th class="number">Average Order Value (Â£)</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Variance Analysis Table -->
                <div class="section">
                    <h2>Month-on-Month Variance Analysis</h2>
                    <div class="table-container">
                        <table id="varianceTable">
                            <thead>
                                <tr>
                                    <th>Sales Rep</th>
                                    <th>Current Month</th>
                                    <th>Previous Month</th>
                                    <th class="number">Total Sales Variance (Â£)</th>
                                    <th class="number">Order Count Variance</th>
                                    <th class="number">Avg Order Value Variance (Â£)</th>
                                    <th class="number">Variance Due to Order Count (Â£)</th>
                                    <th class="number">Variance Due to Avg Order Value (Â£)</th>
                                </tr>
                            </thead>
                            <tbody id="varianceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Order Details</h2>
                <span class="close" onclick="closeOrderModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="order-summary" id="orderSummary">
                    <!-- Summary cards will be inserted here -->
                </div>
                <div class="orders-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Invoice No.</th>
                                <th>Customer</th>
                                <th class="number">Amount (Â£)</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="orderDetailsBody">
                            <!-- Order details will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let filteredData = null;
        let rawTransactionData = []; // Store original transaction data for drill-down
        
        function parseAndProcessData(csvData) {
            // Check if Papa Parse is loaded
            if (typeof Papa === 'undefined') {
                throw new Error('Papa Parse library is not available. Please refresh the page and try again.');
            }
            
            // Skip header rows and parse CSV
            const lines = csvData.split('\n');
            const dataLines = lines.slice(4); // Skip first 4 header lines
            const dataContent = dataLines.join('\n');
            
            const parsed = Papa.parse(dataContent, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true
            });
            
            // Clean and process data
            const cleanData = parsed.data.filter(row => 
                row['Sales Rep'] && 
                row['Transaction date'] && 
                row['No.'] && 
                row['Amount'] !== null && 
                row['Amount'] !== undefined
            );
            
            const processedData = cleanData.map(row => {
                let amount = row['Amount'];
                if (typeof amount === 'string') {
                    amount = parseFloat(amount.replace(/,/g, ''));
                }
                
                const date = parseDate(row['Transaction date']);
                return {
                    ...row,
                    Amount: amount,
                    Month: date.getMonth() + 1,
                    Year: date.getFullYear(),
                    MonthYear: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    FinancialYear: getFinancialYear(date)
                };
            });
            
            // Store raw transaction data globally for drill-down
            rawTransactionData = processedData;
            
            // Add financial year info to processed data
            const dataWithFY = processedData;
            
            // Get unique values
            const uniqueMonths = [...new Set(dataWithFY.map(row => row.MonthYear))].sort();
            const uniqueSalesReps = [...new Set(dataWithFY.map(row => row['Sales Rep']))].sort();
            const uniqueFYs = [...new Set(dataWithFY.map(row => row.FinancialYear))].sort();
            
            // Calculate summary data
            const summaryData = [];
            uniqueSalesReps.forEach(rep => {
                uniqueMonths.forEach(month => {
                    const monthData = dataWithFY.filter(row => 
                        row['Sales Rep'] === rep && row.MonthYear === month
                    );
                    
                    if (monthData.length > 0) {
                        const totalSales = _.sumBy(monthData, 'Amount');
                        const uniqueInvoices = [...new Set(monthData.map(row => row['No.']))];
                        const orderCount = uniqueInvoices.length;
                        const avgOrderValue = totalSales / orderCount;
                        
                        summaryData.push({
                            salesRep: rep,
                            month: month,
                            financialYear: monthData[0].FinancialYear,
                            totalSales: Math.round(totalSales * 100) / 100,
                            orderCount: orderCount,
                            avgOrderValue: Math.round(avgOrderValue * 100) / 100
                        });
                    }
                });
            });
            
            // Calculate variance analysis
            const varianceData = [];
            uniqueSalesReps.forEach(rep => {
                const repData = summaryData.filter(s => s.salesRep === rep).sort((a, b) => a.month.localeCompare(b.month));
                
                for (let i = 1; i < repData.length; i++) {
                    const current = repData[i];
                    const previous = repData[i - 1];
                    
                    const totalSalesVariance = current.totalSales - previous.totalSales;
                    const orderCountVariance = current.orderCount - previous.orderCount;
                    const avgOrderValueVariance = current.avgOrderValue - previous.avgOrderValue;
                    
                    const varianceDueToOrderCount = orderCountVariance * previous.avgOrderValue;
                    const varianceDueToAvgOrderValue = current.orderCount * avgOrderValueVariance;
                    
                    varianceData.push({
                        salesRep: rep,
                        currentMonth: current.month,
                        previousMonth: previous.month,
                        totalSalesVariance: Math.round(totalSalesVariance * 100) / 100,
                        orderCountVariance: orderCountVariance,
                        avgOrderValueVariance: Math.round(avgOrderValueVariance * 100) / 100,
                        varianceDueToOrderCount: Math.round(varianceDueToOrderCount * 100) / 100,
                        varianceDueToAvgOrderValue: Math.round(varianceDueToAvgOrderValue * 100) / 100
                    });
                }
            });
            
            return {
                summaryData: summaryData,
                varianceData: varianceData,
                uniqueMonths: uniqueMonths,
                uniqueSalesReps: uniqueSalesReps,
                uniqueFYs: uniqueFYs
            };
        }
        
        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }
        
        function getFinancialYear(date) {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-based (0 = January)
            
            if (month >= 6) { // July onwards (month 6+)
                return `FY${year.toString().slice(-2)}/${(year + 1).toString().slice(-2)}`;
            } else { // January to June
                return `FY${(year - 1).toString().slice(-2)}/${year.toString().slice(-2)}`;
            }
        }
        
        function isDateInFY(date, fy) {
            if (!fy) return true; // No FY filter
            
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // Extract years from FY string (e.g., "FY24/25" -> [2024, 2025])
            const fyMatch = fy.match(/FY(\d{2})\/(\d{2})/);
            if (!fyMatch) return true;
            
            const fyStartYear = 2000 + parseInt(fyMatch[1]);
            const fyEndYear = 2000 + parseInt(fyMatch[2]);
            
            // Check if date falls within the financial year
            if (year === fyStartYear && month >= 6) return true; // July onwards in start year
            if (year === fyEndYear && month < 6) return true; // January to June in end year
            
            return false;
        }
        
        function formatMonth(monthStr) {
            const [year, month] = monthStr.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('en-GB', { year: 'numeric', month: 'long' });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP'
            }).format(amount);
        }
        
        function showOrderDetails(salesRep, month) {
            // Filter raw data for the selected sales rep and month
            const orderData = rawTransactionData.filter(row => 
                row['Sales Rep'] === salesRep && row.MonthYear === month
            );
            
            // Group by invoice number to get unique orders
            const ordersByInvoice = _.groupBy(orderData, 'No.');
            const orders = Object.keys(ordersByInvoice).map(invoiceNo => {
                const invoiceItems = ordersByInvoice[invoiceNo];
                const totalAmount = _.sumBy(invoiceItems, 'Amount');
                const firstItem = invoiceItems[0];
                
                return {
                    invoiceNo: invoiceNo,
                    date: firstItem['Transaction date'],
                    customer: firstItem['Name'] || 'N/A',
                    amount: totalAmount,
                    type: firstItem['Type'] || 'Invoice',
                    items: invoiceItems
                };
            });
            
            // Sort orders by date
            orders.sort((a, b) => parseDate(a.date) - parseDate(b.date));
            
            // Calculate summary
            const totalSales = _.sumBy(orders, 'amount');
            const orderCount = orders.length;
            const avgOrderValue = totalSales / orderCount;
            
            // Update modal title
            document.getElementById('modalTitle').textContent = 
                `Orders: ${salesRep} - ${formatMonth(month)}`;
            
            // Create summary cards
            const summaryContainer = document.getElementById('orderSummary');
            summaryContainer.innerHTML = `
                <div class="order-summary-item">
                    <div class="label">Total Sales</div>
                    <div class="value">${formatCurrency(totalSales)}</div>
                </div>
                <div class="order-summary-item">
                    <div class="label">Number of Orders</div>
                    <div class="value">${orderCount}</div>
                </div>
                <div class="order-summary-item">
                    <div class="label">Average Order Value</div>
                    <div class="value">${formatCurrency(avgOrderValue)}</div>
                </div>
            `;
            
            // Populate order details table
            const tbody = document.getElementById('orderDetailsBody');
            tbody.innerHTML = '';
            
            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${order.date}</td>
                    <td>${order.invoiceNo}</td>
                    <td>${order.customer}</td>
                    <td class="number">${formatCurrency(order.amount)}</td>
                    <td>${order.type}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show modal
            document.getElementById('orderModal').style.display = 'block';
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        };
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeOrderModal();
            }
        });
        
        function displayDashboard(data) {
            dashboardData = data;
            filteredData = data; // Initialize filtered data
            
            // Hide loading, show results
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardResults').style.display = 'block';
            
            // Populate filter dropdowns
            populateFilters(data);
            
            // Create summary cards
            createSummaryCards(data);
            
            // Populate performance table
            populatePerformanceTable(data.summaryData);
            
            // Populate variance table
            populateVarianceTable(data.varianceData);
        }
        
        function populateFilters(data) {
            // Populate sales rep filter
            const salesRepFilter = document.getElementById('salesRepFilter');
            salesRepFilter.innerHTML = '<option value="">All Sales Reps</option>';
            data.uniqueSalesReps.forEach(rep => {
                const option = document.createElement('option');
                option.value = rep;
                option.textContent = rep;
                salesRepFilter.appendChild(option);
            });
            
            // Populate financial year filter
            const fyFilter = document.getElementById('fyFilter');
            fyFilter.innerHTML = '<option value="">All Financial Years</option>';
            data.uniqueFYs.forEach(fy => {
                const option = document.createElement('option');
                option.value = fy;
                option.textContent = fy;
                fyFilter.appendChild(option);
            });
            
            // Populate month filter (initially all months)
            populateMonthFilter(data.uniqueMonths);
        }
        
        function populateMonthFilter(months) {
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="">All Months</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = formatMonth(month);
                monthFilter.appendChild(option);
            });
        }
        
        function onFYFilterChange() {
            const fyFilter = document.getElementById('fyFilter').value;
            
            // Get months that belong to selected FY
            let availableMonths = dashboardData.uniqueMonths;
            
            if (fyFilter) {
                availableMonths = dashboardData.summaryData
                    .filter(item => item.financialYear === fyFilter)
                    .map(item => item.month);
                availableMonths = [...new Set(availableMonths)].sort();
            }
            
            // Update month dropdown
            populateMonthFilter(availableMonths);
            
            // Clear month selection and apply filters
            document.getElementById('monthFilter').value = '';
            applyFilters();
        }
        
        function applyFilters() {
            const salesRepFilter = document.getElementById('salesRepFilter').value;
            const fyFilter = document.getElementById('fyFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            // Filter summary data
            let filteredSummaryData = dashboardData.summaryData;
            
            if (salesRepFilter) {
                filteredSummaryData = filteredSummaryData.filter(item => item.salesRep === salesRepFilter);
            }
            
            if (fyFilter) {
                filteredSummaryData = filteredSummaryData.filter(item => item.financialYear === fyFilter);
            }
            
            if (monthFilter) {
                filteredSummaryData = filteredSummaryData.filter(item => item.month === monthFilter);
            }
            
            // Filter variance data
            let filteredVarianceData = dashboardData.varianceData;
            
            if (salesRepFilter) {
                filteredVarianceData = filteredVarianceData.filter(item => item.salesRep === salesRepFilter);
            }
            
            if (fyFilter) {
                // For variance data, both current and previous month should be in the same FY
                filteredVarianceData = filteredVarianceData.filter(item => {
                    const currentDate = new Date(item.currentMonth + '-01');
                    const previousDate = new Date(item.previousMonth + '-01');
                    return isDateInFY(currentDate, fyFilter) && isDateInFY(previousDate, fyFilter);
                });
            }
            
            if (monthFilter) {
                // For variance data, filter by current month
                filteredVarianceData = filteredVarianceData.filter(item => item.currentMonth === monthFilter);
            }
            
            // Create filtered data object
            filteredData = {
                summaryData: filteredSummaryData,
                varianceData: filteredVarianceData,
                uniqueMonths: salesRepFilter || fyFilter ? 
                    [...new Set(filteredSummaryData.map(item => item.month))].sort() : 
                    dashboardData.uniqueMonths,
                uniqueSalesReps: monthFilter || fyFilter ? 
                    [...new Set(filteredSummaryData.map(item => item.salesRep))].sort() : 
                    dashboardData.uniqueSalesReps,
                uniqueFYs: salesRepFilter || monthFilter ?
                    [...new Set(filteredSummaryData.map(item => item.financialYear))].sort() :
                    dashboardData.uniqueFYs
            };
            
            // Update display
            updateFilteredDisplay();
        }
        
        function clearFilters() {
            document.getElementById('salesRepFilter').value = '';
            document.getElementById('fyFilter').value = '';
            document.getElementById('monthFilter').value = '';
            
            // Reset month filter to show all months
            populateMonthFilter(dashboardData.uniqueMonths);
            
            filteredData = dashboardData;
            updateFilteredDisplay();
        }
        
        function updateFilteredDisplay() {
            // Remove any existing filter info
            const existingInfo = document.querySelector('.filtered-info');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // Add filter info if filters are applied
            const salesRepFilter = document.getElementById('salesRepFilter').value;
            const fyFilter = document.getElementById('fyFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            if (salesRepFilter || fyFilter || monthFilter) {
                const filterInfo = document.createElement('div');
                filterInfo.className = 'filtered-info';
                let filterText = 'Filtered by: ';
                const filters = [];
                
                if (salesRepFilter) filters.push(`Sales Rep: ${salesRepFilter}`);
                if (fyFilter) filters.push(`Financial Year: ${fyFilter}`);
                if (monthFilter) filters.push(`Month: ${formatMonth(monthFilter)}`);
                
                filterInfo.textContent = filterText + filters.join(', ');
                
                // Insert after filters section
                const filtersSection = document.querySelector('.section');
                filtersSection.parentNode.insertBefore(filterInfo, filtersSection.nextSibling);
            }
            
            // Update summary cards
            createSummaryCards(filteredData);
            
            // Update tables
            populatePerformanceTable(filteredData.summaryData);
            populateVarianceTable(filteredData.varianceData);
        }
        
        function createSummaryCards(data) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            // Calculate totals based on filtered data
            if (data.summaryData.length === 0) {
                container.innerHTML = '<div class="summary-card"><h3>No Data</h3><div class="value">No records match the selected filters</div></div>';
                return;
            }
            
            const totalSales = _.sumBy(data.summaryData, 'totalSales');
            const totalOrders = _.sumBy(data.summaryData, 'orderCount');
            const avgOrderValueOverall = totalOrders > 0 ? totalSales / totalOrders : 0;
            const activeReps = data.uniqueSalesReps.length;
            const monthsTracked = data.uniqueMonths.length;
            
            const cards = [
                { title: 'Total Sales', value: formatCurrency(totalSales) },
                { title: 'Total Orders', value: totalOrders.toLocaleString() },
                { title: 'Average Order Value', value: formatCurrency(avgOrderValueOverall) }
            ];
            
            cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'summary-card';
                cardDiv.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="value">${card.value}</div>
                `;
                container.appendChild(cardDiv);
            });
        }
        
        function populatePerformanceTable(summaryData) {
            const tbody = document.getElementById('performanceTableBody');
            tbody.innerHTML = '';
            
            if (summaryData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" style="text-align: center; color: #666; padding: 30px;">No data matches the selected filters</td>';
                tbody.appendChild(tr);
                return;
            }
            
            summaryData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.salesRep}</td>
                    <td>${formatMonth(row.month)}</td>
                    <td class="number clickable-sales" onclick="showOrderDetails('${row.salesRep}', '${row.month}')">${formatCurrency(row.totalSales)}</td>
                    <td class="number">${row.orderCount}</td>
                    <td class="number">${formatCurrency(row.avgOrderValue)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function populateVarianceTable(varianceData) {
            const tbody = document.getElementById('varianceTableBody');
            tbody.innerHTML = '';
            
            if (varianceData.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" style="text-align: center; color: #666; padding: 30px;">No variance data available for the selected filters</td>';
                tbody.appendChild(tr);
                return;
            }
            
            varianceData.forEach(row => {
                const tr = document.createElement('tr');
                
                const formatVariance = (value) => {
                    const formatted = typeof value === 'number' ? 
                        (value >= 0 ? '+' : '') + (Math.abs(value) >= 1000 ? 
                            formatCurrency(value) : 
                            'Â£' + value.toFixed(2)) : 
                        value.toString();
                    return `<span class="${value >= 0 ? 'positive' : 'negative'}">${formatted}</span>`;
                };
                
                const formatOrderVariance = (value) => {
                    const formatted = (value >= 0 ? '+' : '') + value.toString();
                    return `<span class="${value >= 0 ? 'positive' : 'negative'}">${formatted}</span>`;
                };
                
                tr.innerHTML = `
                    <td>${row.salesRep}</td>
                    <td>${formatMonth(row.currentMonth)}</td>
                    <td>${formatMonth(row.previousMonth)}</td>
                    <td class="number">${formatVariance(row.totalSalesVariance)}</td>
                    <td class="number">${formatOrderVariance(row.orderCountVariance)}</td>
                    <td class="number">${formatVariance(row.avgOrderValueVariance)}</td>
                    <td class="number">${formatVariance(row.varianceDueToOrderCount)}</td>
                    <td class="number">${formatVariance(row.varianceDueToAvgOrderValue)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Load data from CSV file automatically
        window.addEventListener('load', function() {
            loadCSVFromFile();
        });
        
        async function loadCSVFromFile() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                
                // Check if Papa Parse is loaded
                if (typeof Papa === 'undefined') {
                    throw new Error('Papa Parse library failed to load');
                }
                
                const response = await fetch('sales-data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvData = await response.text();
                const processedData = parseAndProcessData(csvData);
                displayDashboard(processedData);
                
            } catch (error) {
                console.error('Error loading CSV file:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Could not load sales-data.csv automatically.</strong><br>
                    Error: ${error.message}<br>
                    Please ensure the sales-data.csv file exists in the same directory.
                `;
                
                // Show fallback sample data
                showSampleData();
            }
        }
        
        function showSampleData() {
            // Create sample raw transaction data for drill-down
            rawTransactionData = [
                {"Sales Rep":"Adam Bell","Transaction date":"15/05/2025","No.":"INV-001","Name":"Customer A","Amount":60,"Type":"Invoice","Month":5,"Year":2025,"MonthYear":"2025-05","FinancialYear":"FY24/25"},
                {"Sales Rep":"Michael Bell","Transaction date":"10/03/2025","No.":"INV-002","Name":"Customer B","Amount":500,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"},
                {"Sales Rep":"Michael Bell","Transaction date":"15/03/2025","No.":"INV-003","Name":"Customer C","Amount":750,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"},
                {"Sales Rep":"Michael Bell","Transaction date":"20/03/2025","No.":"INV-004","Name":"Customer D","Amount":650,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"},
                {"Sales Rep":"Michael Bell","Transaction date":"25/03/2025","No.":"INV-005","Name":"Customer E","Amount":527.5,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"},
                {"Sales Rep":"Ria Wise","Transaction date":"05/03/2025","No.":"INV-006","Name":"Customer F","Amount":1200,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"},
                {"Sales Rep":"Ria Wise","Transaction date":"08/03/2025","No.":"INV-007","Name":"Customer G","Amount":850,"Type":"Invoice","Month":3,"Year":2025,"MonthYear":"2025-03","FinancialYear":"FY24/25"}
            ];
            
            const sampleData = {
                summaryData: [
                    {"salesRep":"Adam Bell","month":"2025-05","financialYear":"FY24/25","totalSales":60,"orderCount":1,"avgOrderValue":60},
                    {"salesRep":"Michael Bell","month":"2025-03","financialYear":"FY24/25","totalSales":2427.5,"orderCount":4,"avgOrderValue":606.88},
                    {"salesRep":"Michael Bell","month":"2025-04","financialYear":"FY24/25","totalSales":9241.08,"orderCount":11,"avgOrderValue":840.1},
                    {"salesRep":"Michael Bell","month":"2025-05","financialYear":"FY24/25","totalSales":9462.5,"orderCount":12,"avgOrderValue":788.54},
                    {"salesRep":"Michael Bell","month":"2025-06","financialYear":"FY24/25","totalSales":21035.99,"orderCount":19,"avgOrderValue":1107.16},
                    {"salesRep":"Ria Wise","month":"2025-03","financialYear":"FY24/25","totalSales":13009.17,"orderCount":14,"avgOrderValue":929.23},
                    {"salesRep":"Ria Wise","month":"2025-04","financialYear":"FY24/25","totalSales":17413.32,"orderCount":18,"avgOrderValue":967.41},
                    {"salesRep":"Ria Wise","month":"2025-05","financialYear":"FY24/25","totalSales":15460.86,"orderCount":15,"avgOrderValue":1030.72},
                    {"salesRep":"Ria Wise","month":"2025-06","financialYear":"FY24/25","totalSales":23631.65,"orderCount":21,"avgOrderValue":1125.32}
                ],
                varianceData: [
                    {"salesRep":"Michael Bell","currentMonth":"2025-04","previousMonth":"2025-03","totalSalesVariance":6813.58,"orderCountVariance":7,"avgOrderValueVariance":233.22,"varianceDueToOrderCount":4248.16,"varianceDueToAvgOrderValue":2565.42},
                    {"salesRep":"Michael Bell","currentMonth":"2025-05","previousMonth":"2025-04","totalSalesVariance":221.42,"orderCountVariance":1,"avgOrderValueVariance":-51.56,"varianceDueToOrderCount":840.1,"varianceDueToAvgOrderValue":-618.72},
                    {"salesRep":"Michael Bell","currentMonth":"2025-06","previousMonth":"2025-05","totalSalesVariance":11573.49,"orderCountVariance":7,"avgOrderValueVariance":318.62,"varianceDueToOrderCount":5519.78,"varianceDueToAvgOrderValue":6053.78},
                    {"salesRep":"Ria Wise","currentMonth":"2025-04","previousMonth":"2025-03","totalSalesVariance":4404.15,"orderCountVariance":4,"avgOrderValueVariance":38.18,"varianceDueToOrderCount":3716.92,"varianceDueToAvgOrderValue":687.24},
                    {"salesRep":"Ria Wise","currentMonth":"2025-05","previousMonth":"2025-04","totalSalesVariance":-1952.46,"orderCountVariance":-3,"avgOrderValueVariance":63.31,"varianceDueToOrderCount":-2902.23,"varianceDueToAvgOrderValue":949.65},
                    {"salesRep":"Ria Wise","currentMonth":"2025-06","previousMonth":"2025-05","totalSalesVariance":8170.79,"orderCountVariance":6,"avgOrderValueVariance":94.6,"varianceDueToOrderCount":6184.32,"varianceDueToAvgOrderValue":1986.6}
                ],
                uniqueMonths: ["2025-03","2025-04","2025-05","2025-06"],
                uniqueSalesReps: ["Adam Bell","Michael Bell","Ria Wise"],
                uniqueFYs: ["FY24/25","FY25/26"]
            };
            
            displayDashboard(sampleData);
        }
    </script>
</body>
</html>
